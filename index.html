<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./css/style.css" />
    <title>Template Whatsapp Generator</title>
  </head>
  <body>
    <div class="app">
      <div class="card">
        <h1>Generator Template WhatsApp</h1>
        <p class="lead">Pilih template → Isi kolom → <span class="badge">Buat</span> → <strong>Salin</strong>.</p>

        <div class="grid">
          <div class="col-6">
            <label for="tpl">Pilih Template</label>
            <select id="tpl"></select>
          </div>
        </div>

        <div id="fields" class="grid" style="margin-top: 10px"></div>

        <div class="divider"></div>

        <label for="output">Hasil</label>
        <textarea
          id="output"
          placeholder="Teks hasil akan muncul di sini…"
          spellcheck="false"
          autocapitalize="off"
        ></textarea>

        <div class="toolbar">
          <button class="primary" id="btn-gen">Buat Template</button>
          <button id="btn-copy">Salin Teks</button>
          <button id="btn-wa">Buka di WhatsApp</button>
        </div>

        <div class="hint">Catatan: Format *tebal* dan lainnya akan terbawa sesuai format WhatsApp.</div>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <datalist id="vendor-list">
      <option value="Jeje"></option>
      <option value="Vendor A"></option>
      <option value="Vendor B"></option>
    </datalist>

    <script>
      (function () {
        "use strict";

        const $ = (selector) => document.querySelector(selector);

        const DOM = {
          tplSelect: $("#tpl"),
          fieldsContainer: $("#fields"),
          output: $("#output"),
          btnGen: $("#btn-gen"),
          btnCopy: $("#btn-copy"),
          btnWa: $("#btn-wa"),
          toast: $("#toast"),
        };

        const DAYS = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
        const MONTHS = [
          "Januari",
          "Februari",
          "Maret",
          "April",
          "Mei",
          "Juni",
          "Juli",
          "Agustus",
          "September",
          "Oktober",
          "November",
          "Desember",
        ];
        const ID_FLAG = "\uD83C\uDDEE\uD83C\uDDE9"; // TEMPLATES DEFINITION (REVISED FOR CONSISTENCY) // =================================================

        // =================================================
        const templates = [
          {
            id: "unit-bjm-masuk",
            name: "Template Unit Banjarmasin Masuk",
            fields: [
              { key: "tanggal", label: "Tanggal", type: "date", span: 6 },
              { key: "jam", label: "Jam (24h, WITA)", type: "time-24", span: 6 },
              { key: "nopol", label: "Nopol", span: 6 },
              { key: "vendor", label: "Vendor", span: 6, default: "Jeje", datalist: "vendor-list" },
            ],
            render: ({ greet, tanggal, hari, nopol, vendor, jam }) => {
              const lines = [
                `*Selamat ${greet}* ${ID_FLAG}`,
                `*SPX DC Balikpapan >< PT. KRESNA JAGANNATHA MANDIRI*`,
                "",
                "*Mohon izin melaporkan*",
                `*Hari   :* ${hari}`,
                `*Tanggal  :* ${tanggal}`,
                `*Nopol  :* ${nopol}`,
                `*Vendor  :* ${vendor}`,
                `*Jam   :* ${jam} WITA`,
                `*Catatan :* Telah tiba di Balikpapan Barat DC`,
                "",
                "@~Rizky",
                "@~rickyv satwika",
                "@+62 877-7624-0125",
              ];
              return lines.join("\n");
            },
          },
          {
            id: "patroli",
            name: "Template Patroli",
            fields: [
              { key: "tanggal", label: "Tanggal", type: "date", span: 6 },
              { key: "jam", label: "Pukul (24h, WITA)", type: "time-24", span: 6 },
              { key: "petugas", label: "Petugas", span: 6 },
              { key: "regu", label: "Regu", span: 6, default: "2" },
            ],
            render: ({ greet, tanggal, hari, jam, petugas, regu }) => {
              const lines = [
                "*PT.KRESNA JAGANNATHA MANDIRI*",
                "_________________________________",
                "*SPX EXPRESS BALIKPAPAN BARAT DC*",
                "_________________________________",
                `*Selamat ${greet}* Komandan KJM / Pimpinan SPX`,
                "Mohon izin melaporkan, Komandan",
                "",
                `*Hari   :* ${hari}`,
                `*Tanggal  :* ${tanggal}`,
                `*Pukul  :* ${jam} WITA`,
                `*Lokasi  :* Balikpapan Barat DC`,
                `*Perihal :* Pengecekan personel di setiap lantai dan patroli situasi gudang SPX Express Balikpapan Barat DC`,
                "",
                `*Petugas :* ( ${petugas} ) Regu ${regu}`,
                "",
                "*Keterangan*",
                "• Patroli di seluruh area SPX EXPRESS BALIKPAPAN BARAT DC",
                "• Situasi area aman kondusif.",
                "• Inventaris dalam keadaan lengkap dan aman",
              ];
              return lines.join("\n");
            },
          },
          {
            id: "loker",
            name: "Template Loker (Inventaris Security)",
            fields: [{ key: "tanggalfull", label: "Hari, Tanggal", type: "date", span: 6 }],
            render: ({ greet, tanggalfull }) => {
              const lines = [
                `*Selamat ${greet} Komandan*`,
                "*SPX DC Balikpapan >< PT. KRESNA JAGANNATHA MANDIRI*",
                "",
                `*${tanggalfull}*`,
                "Mohon izin melaporkan kelengkapan inventaris Security",
                "",
                "Rincian inventaris :",
                "• 1 Jas hujan warna kuning",
                "• 1 Stel sepatu boots",
                "• 2 HT Wlan",
                "• 1 Metal detektor",
                "• 1 Buah kabel charger",
                "",
                "Dalam keadaan baik, aman dan lengkap",
              ];
              return lines.join("\n");
            },
          },
        ];

        // The rest of the JavaScript logic remains the same
        const todayLocalISO = () => new Date().toISOString().slice(0, 10);
        const parseDateLocal = (iso) => {
          const [y, m, d] = iso.split("-").map(Number);
          return new Date(y, m - 1, d);
        };
        const formatDate = (value, withDay = false) => {
          const date = parseDateLocal(value);
          if (isNaN(date)) return withDay ? "" : { day: "", dateStr: "" };
          const d = date.getDate();
          const m = MONTHS[date.getMonth()];
          const y = date.getFullYear();
          const day = DAYS[date.getDay()];
          return withDay ? `${day}, ${d} ${m} ${y}` : { day, dateStr: `${d} ${m} ${y}` };
        };
        const normalizeTime = (rawTime) => {
          if (!rawTime) return "";
          const digits = String(rawTime).replace(/\D/g, "");
          let h, m;
          if (digits.length === 1) {
            h = `0${digits}`;
            m = "00";
          } else if (digits.length === 2) {
            h = digits;
            m = "00";
          } else if (digits.length === 3) {
            h = `0${digits[0]}`;
            m = digits.slice(1);
          } else if (digits.length === 4) {
            h = digits.slice(0, 2);
            m = digits.slice(2);
          } else {
            return "";
          }
          if (parseInt(h, 10) > 23 || parseInt(m, 10) > 59) return "";
          return `${h}:${m}`;
        };
        const greetByHour = (h) => {
          if (h < 11) return "Pagi";
          if (h < 15) return "Siang";
          if (h < 19) return "Sore";
          return "Malam";
        };
        const guessGreet = (jamVal) => {
          const normalizedTime = normalizeTime(jamVal || "");
          const hour = normalizedTime ? parseInt(normalizedTime.split(":")[0], 10) : new Date().getHours();
          return greetByHour(hour);
        };
        const showToast = (msg) => {
          DOM.toast.textContent = msg;
          DOM.toast.classList.add("show");
          setTimeout(() => DOM.toast.classList.remove("show"), 2500);
        };
        const renderFields = (tpl) => {
          DOM.fieldsContainer.innerHTML = "";
          tpl.fields.forEach((field) => {
            const wrap = document.createElement("div");
            wrap.className = `col-${field.span || 6}`;
            const label = `<label for="f-${field.key}">${field.label}</label>`;
            let inputHTML = "";
            const commonAttrs = `id="f-${field.key}" data-key="${field.key}" autocomplete="off" required`;
            switch (field.type) {
              case "date":
                inputHTML = `<input type="date" ${commonAttrs} value="${todayLocalISO()}" />`;
                break;
              case "time-24":
                inputHTML = `<input type="text" ${commonAttrs} inputmode="numeric" placeholder="HH:MM" maxlength="5" value="${
                  field.default ?? ""
                }" />`;
                break;
              default:
                const listAttr = field.datalist ? `list="${field.datalist}"` : "";
                inputHTML = `<input type="text" ${commonAttrs} placeholder="${field.label}" value="${
                  field.default ?? ""
                }" ${listAttr} />`;
                break;
            }
            wrap.innerHTML = label + inputHTML;
            DOM.fieldsContainer.appendChild(wrap);
          });
        };
        const getCurrentTemplate = () => {
          const id = DOM.tplSelect.value;
          return templates.find((t) => t.id === id) || templates[0];
        };
        const collectValues = () => {
          const tpl = getCurrentTemplate();
          const values = {};
          tpl.fields.forEach((field) => {
            const el = $(`#f-${field.key}`);
            const val = el.value.trim();
            switch (field.type) {
              case "date":
                if (field.key === "tanggalfull") {
                  values.tanggalfull = formatDate(val, true);
                } else {
                  const { day, dateStr } = formatDate(val);
                  values.hari = day;
                  values.tanggal = dateStr;
                }
                break;
              case "time-24":
                values[field.key] = normalizeTime(val);
                break;
              default:
                values[field.key] = field.key === "nopol" ? val.toUpperCase() : val;
                break;
            }
          });
          const timeValue = values.jam || "";
          values.greet = guessGreet(timeValue);
          return values;
        };
        const validateFields = () => {
          for (const field of getCurrentTemplate().fields) {
            const el = $(`#f-${field.key}`);
            if (!el.value.trim()) {
              showToast(`${field.label} wajib diisi`);
              el.focus();
              return false;
            }
            if (field.type === "time-24" && !normalizeTime(el.value)) {
              showToast(`Format ${field.label} tidak valid (contoh: 20:00 atau 2000)`);
              el.focus();
              return false;
            }
          }
          return true;
        };
        const generate = () => {
          if (!validateFields()) return;
          const values = collectValues();
          const outputText = getCurrentTemplate().render(values);
          DOM.output.value = outputText;
        };
        const handleTemplateChange = () => {
          renderFields(getCurrentTemplate());
          DOM.output.value = "";
        };
        const handleCopyClick = async () => {
          const text = DOM.output.value.trim();
          if (!text) return;
          try {
            await navigator.clipboard.writeText(text);
            const originalText = DOM.btnCopy.textContent;
            DOM.btnCopy.textContent = "Copied ✓";
            setTimeout(() => (DOM.btnCopy.textContent = originalText), 1500);
          } catch {
            showToast("Gagal menyalin. Silakan salin manual.");
          }
        };
        const handleWhatsAppClick = () => {
          const text = DOM.output.value.trim();
          if (!text) return;
          const encodedText = encodeURIComponent(text);
          const url = `https://wa.me/?text=${encodedText}`;
          window.open(url, "_blank", "noopener,noreferrer");
        };
        const handleTimeInputBlur = (e) => {
          if (e.target.matches('input[data-key][placeholder="HH:MM"]')) {
            const normalized = normalizeTime(e.target.value);
            if (normalized) e.target.value = normalized;
          }
        };
        const init = () => {
          templates.forEach((t) => {
            DOM.tplSelect.add(new Option(t.name, t.id));
          });
          renderFields(getCurrentTemplate());
          DOM.tplSelect.addEventListener("change", handleTemplateChange);
          DOM.btnGen.addEventListener("click", generate);
          DOM.btnCopy.addEventListener("click", handleCopyClick);
          DOM.btnWa.addEventListener("click", handleWhatsAppClick);
          DOM.fieldsContainer.addEventListener("blur", handleTimeInputBlur, true);
        };
        init();
      })();
    </script>
  </body>
</html>
