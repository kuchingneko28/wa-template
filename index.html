<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./css/style.css" />
    <title>Template Whatsapp Generator</title>
  </head>
  <body>
    <div class="app">
      <div class="card">
        <h1>Generator Template WhatsApp</h1>
        <p class="lead">Pilih template, isi kolom, dan salin hasilnya dengan mudah.</p>
        <div class="grid"><div class="col-12" id="tpl-container"></div></div>
        <div id="fields" class="grid" style="margin-top: 10px"></div>
        <div class="divider"></div>
        <h2>Hasil Template</h2>
        <textarea id="output" placeholder="Teks hasil akan muncul di siniâ€¦"></textarea>
        <div class="toolbar">
          <button class="primary" id="btn-gen">Buat Template</button>
          <button id="btn-copy">Salin Teks</button>
          <button id="btn-wa">Kirim di WhatsApp</button>
        </div>
        <div id="nopol-list-container" style="display: none">
          <div class="divider"></div>
          <h2>Daftar Nopol (Klik untuk menandai)</h2>
          <div id="nopol-list-display"></div>
          <div class="toolbar">
            <button id="btn-export">Export ke .txt</button>
            <button id="btn-clear" class="danger">Clear List</button>
          </div>
        </div>
      </div>
    </div>
    <div id="toast" class="toast"></div>
    <datalist id="vendor-list"><option value="Jeje"></option></datalist>

    <script>
      (function () {
        "use strict";
        const $ = (s) => document.querySelector(s);
        const DOM = {
          tplContainer: $("#tpl-container"),
          fieldsContainer: $("#fields"),
          output: $("#output"),
          btnGen: $("#btn-gen"),
          btnCopy: $("#btn-copy"),
          btnWa: $("#btn-wa"),
          toast: $("#toast"),
          nopolListContainer: $("#nopol-list-container"),
          nopolListDisplay: $("#nopol-list-display"),
          btnExport: $("#btn-export"),
          btnClear: $("#btn-clear"),
        };
        const ICONS = {
          template: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22h6a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v10"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10.4 12.6a2 2 0 1 1 3 3L8 21l-4 1 1-4Z"/></svg>`,
          calendar: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>`,
          clock: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>`,
          car: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><path d="M7 17h10"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></svg>`,
          user: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
          users: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
          sparkle: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22h6a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v10"/><path d="m15 18-1-1-1 1-1-1-1 1-1-1-1 1"/><path d="m22 12-1-1-1 1-1-1-1 1-1-1-1 1"/></svg>`,
          copy: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`,
          check: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>`,
          whatsapp: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>`,
          download: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>`,
          trash: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`,
        };
        const FIELD_ICONS = {
          tanggal: ICONS.calendar,
          jam: ICONS.clock,
          nopol: ICONS.car,
          vendor: ICONS.user,
          petugas: ICONS.user,
          regu: ICONS.users,
          tanggalfull: ICONS.calendar,
        };

        const DAYS = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
        const MONTHS = [
          "Januari",
          "Februari",
          "Maret",
          "April",
          "Mei",
          "Juni",
          "Juli",
          "Agustus",
          "September",
          "Oktober",
          "November",
          "Desember",
        ];
        let nopolList = [];
        const templates = [
          {
            id: "unit-bjm-masuk",
            name: "Template Unit Banjarmasin Masuk",
            fields: [
              { key: "tanggal", label: "Tanggal", type: "date", span: 6 },
              { key: "jam", label: "Jam (24h, WITA)", type: "time-24", span: 6 },
              { key: "nopol", label: "Nopol", span: 6 },
              { key: "vendor", label: "Vendor", span: 6, default: "Jeje", datalist: "vendor-list" },
            ],
            render: ({ greet, tanggal, hari, nopol, vendor, jam }) =>
              [
                `ðŸ‡®ðŸ‡© *Selamat ${greet}*`,
                `*SPX DC Balikpapan >< PT. KRESNA JAGANNATHA MANDIRI*`,
                "",
                "*Mohon izin melaporkan*",
                `*Hari   :* ${hari}`,
                `*Tanggal  :* ${tanggal}`,
                `*Nopol   :* ${nopol}`,
                `*Vendor   :* ${vendor}`,
                `*Jam   :* ${jam} WITA`,
                `*Catatan :* Telah tiba di Balikpapan DC`,
                "",
                "@~Rizky",
                "@~rickyv satwika",
                "@+62 877-7624-0125",
              ].join("\n"),
          },
          {
            id: "patroli",
            name: "Template Patroli",
            fields: [
              { key: "tanggal", label: "Tanggal", type: "date", span: 6 },
              { key: "jam", label: "Pukul (24h, WITA)", type: "time-24", span: 6 },
              { key: "petugas", label: "Petugas", span: 6 },
              { key: "regu", label: "Regu", span: 6, default: "2" },
            ],
            render: ({ greet, tanggal, hari, jam, petugas, regu }) =>
              [
                "*PT.KRESNA JAGANNATHA MANDIRI*",
                "_________________________________",
                "*SPX EXPRESS BALIKPAPAN BARAT DC*",
                "_________________________________",
                `*Selamat ${greet}* Komandan KJM / Pimpinan SPX`,
                "Mohon izin melaporkan, Komandan",
                "",
                `*Hari   :* ${hari}`,
                `*Tanggal  :* ${tanggal}`,
                `*Pukul   :* ${jam} WITA`,
                `*Lokasi   :* Balikpapan Barat DC`,
                `*Perihal :* Pengecekan personel di setiap lantai dan patroli situasi gudang SPX Express Balikpapan Barat DC`,
                "",
                `*Petugas :* ( ${petugas} ) Regu ${regu}`,
                "",
                "*Keterangan*",
                "â€¢ Patroli di seluruh area SPX EXPRESS BALIKPAPAN BARAT DC",
                "â€¢ Situasi area aman kondusif.",
                "â€¢ Inventaris dalam keadaan lengkap dan aman",
              ].join("\n"),
          },
          {
            id: "loker",
            name: "Template Loker (Inventaris Security)",
            fields: [{ key: "tanggalfull", label: "Hari, Tanggal", type: "date", span: 12 }],
            render: ({ greet, tanggalfull }) =>
              [
                `*Selamat ${greet} Komandan*`,
                "*SPX DC Balikpapan >< PT. KRESNA JAGANNATHA MANDIRI*",
                "",
                `*${tanggalfull}*`,
                "Mohon izin melaporkan kelengkapan inventaris Security",
                "",
                "Rincian inventaris :",
                "â€¢ 1 Jas hujan warna kuning",
                "â€¢ 1 Stel sepatu boots",
                "â€¢ 2 HT Wlan",
                "â€¢ 1 Metal detektor",
                "â€¢ 1 Buah kabel charger",
                "",
                "Dalam keadaan baik, aman dan lengkap",
              ].join("\n"),
          },
        ];

        const getWitaDate = () => new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Makassar" }));
        const getTodayWitaISO = () => {
          const n = getWitaDate();
          return `${n.getFullYear()}-${String(n.getMonth() + 1).padStart(2, "0")}-${String(n.getDate()).padStart(
            2,
            "0"
          )}`;
        };
        const getCurrentTimeWita = () => {
          const n = getWitaDate();
          return `${String(n.getHours()).padStart(2, "0")}:${String(n.getMinutes()).padStart(2, "0")}`;
        };
        const formatDateTimeForList = (iso) => {
          const d = new Date(iso);
          if (isNaN(d)) return "Invalid time";
          const day = String(d.getDate()).padStart(2, "0");
          const month = String(d.getMonth() + 1).padStart(2, "0");
          const time = `${String(d.getHours()).padStart(2, "0")}:${String(d.getMinutes()).padStart(2, "0")}`;
          return `${time} - ${day}/${month}`;
        };
        const parseDateLocal = (iso) => {
          const [y, m, d] = iso.split("-").map(Number);
          return new Date(y, m - 1, d);
        };
        const formatDate = (val, withDay = false) => {
          const d = parseDateLocal(val);
          if (isNaN(d)) return withDay ? "" : { day: "", dateStr: "" };
          const dayName = DAYS[d.getDay()],
            dayOfMonth = d.getDate(),
            monthName = MONTHS[d.getMonth()],
            year = d.getFullYear();
          return withDay
            ? `${dayName}, ${dayOfMonth} ${monthName} ${year}`
            : { day: dayName, dateStr: `${dayOfMonth} ${monthName} ${year}` };
        };
        const normalizeTime = (raw) => {
          if (!raw) return "";
          const d = String(raw).replace(/\D/g, "");
          let h, m;
          if (d.length <= 2) {
            h = d.padStart(2, "0");
            m = "00";
          } else if (d.length === 3) {
            h = `0${d[0]}`;
            m = d.slice(1);
          } else {
            h = d.slice(0, 2);
            m = d.slice(2, 4);
          }
          if (parseInt(h, 10) > 23 || parseInt(m, 10) > 59) return "";
          return `${h}:${m}`;
        };
        const greetByHour = (h) => {
          if (h < 11) return "Pagi";
          if (h < 15) return "Siang";
          if (h < 19) return "Sore";
          return "Malam";
        };
        const guessGreet = (jam) => {
          const t = normalizeTime(jam || "");
          const h = t ? parseInt(t.split(":")[0], 10) : getWitaDate().getHours();
          return greetByHour(h);
        };
        const showToast = (msg, icon = ICONS.check) => {
          DOM.toast.innerHTML = `${icon} ${msg}`;
          DOM.toast.classList.add("show");
          setTimeout(() => DOM.toast.classList.remove("show"), 2500);
        };

        const renderNopolList = () => {
          DOM.nopolListDisplay.innerHTML = "";
          if (nopolList.length === 0) {
            DOM.nopolListDisplay.innerHTML = `<div class="nopol-item" style="color: var(--overlay0); cursor: default;">Belum ada nopol yang dibuat untuk tanggal ini.</div>`;
            return;
          }
          nopolList.forEach((item) => {
            const el = document.createElement("div");
            el.className = `nopol-item ${item.done ? "done" : ""}`;
            el.dataset.nopol = item.nopol;
            const check = item.done
              ? `<span class="check">âœ“</span>`
              : `<span class="check" style="opacity: 0.2;">-</span>`;
            const details = `<span class="details">${formatDateTimeForList(item.timestamp)}</span>`;
            el.innerHTML = `${check} <span>${item.nopol}</span> ${details}`;
            DOM.nopolListDisplay.appendChild(el);
          });
        };
        const loadNopolListForDate = (date) => {
          if (!date) return;
          const d = localStorage.getItem(`nopolList_${date}`);
          nopolList = d ? JSON.parse(d) : [];
          renderNopolList();
        };
        const saveNopolListForDate = (date) => {
          if (!date) return;
          localStorage.setItem(`nopolList_${date}`, JSON.stringify(nopolList));
        };
        const addNopolToList = (nopol, date) => {
          if (typeof nopol !== "string" || !nopol.trim() || !date) return;
          const upperNopol = nopol.trim().toUpperCase();
          if (nopolList.some((item) => item.nopol === upperNopol)) {
            showToast(`Nopol ${upperNopol} sudah ada.`);
            return;
          }
          const newItem = { nopol: upperNopol, done: false, timestamp: new Date().toISOString() };
          nopolList.push(newItem);
          saveNopolListForDate(date);
          renderNopolList();
        };

        const renderFields = (tpl) => {
          DOM.fieldsContainer.innerHTML = "";
          if (!tpl) return;
          tpl.fields.forEach((f) => {
            const w = document.createElement("div");
            w.className = `col-${f.span || 12}`;
            const icon = `<span class="icon">${FIELD_ICONS[f.key] || ""}</span>`;
            let inputHTML = "";
            const a = `id="f-${f.key}" data-key="${f.key}" autocomplete="off" required`;
            switch (f.type) {
              case "date":
                inputHTML = `<input type="date" ${a} value="${getTodayWitaISO()}"/>`;
                break;
              case "time-24":
                inputHTML = `<input type="text" ${a} inputmode="numeric" placeholder="HH:MM" maxlength="5" value="${getCurrentTimeWita()}"/>`;
                break;
              default:
                const d = f.datalist ? `list="${f.datalist}"` : "";
                inputHTML = `<input type="text" ${a} placeholder="${f.label}" value="${f.default ?? ""}" ${d}/>`;
                break;
            }
            w.innerHTML = `<div class="form-group"><label for="f-${f.key}">${f.label}</label><div class="input-wrapper">${icon}${inputHTML}</div></div>`;
            DOM.fieldsContainer.appendChild(w);
          });
          DOM.nopolListContainer.style.display = tpl.id === "unit-bjm-masuk" ? "block" : "none";
          if (tpl.id === "unit-bjm-masuk") {
            const d = $("#f-tanggal");
            if (d) loadNopolListForDate(d.value);
          }
        };

        const createSelect = () => {
          const selectHTML = `<select id="tpl">${templates
            .map((t) => `<option value="${t.id}">${t.name}</option>`)
            .join("")}</select>`;
          DOM.tplContainer.innerHTML = `<div class="form-group"><label for="tpl">Pilih Template</label><div class="input-wrapper"><span class="icon">${ICONS.template}</span>${selectHTML}</div></div>`;
          $("#tpl").addEventListener("change", handleTemplateChange);
        };

        const getCurrentTemplate = () => templates.find((t) => t.id === $("#tpl").value) || templates[0];
        const collectValues = () => {
          const tpl = getCurrentTemplate(),
            values = {};
          tpl.fields.forEach((f) => {
            const el = $(`#f-${f.key}`);
            if (!el) return;
            const val = el.value.trim();
            switch (f.type) {
              case "date":
                if (f.key === "tanggalfull") values.tanggalfull = formatDate(val, true);
                else {
                  const { day, dateStr } = formatDate(val);
                  values.hari = day;
                  values.tanggal = dateStr;
                }
                break;
              case "time-24":
                values[f.key] = normalizeTime(val);
                break;
              default:
                values[f.key] = f.key === "nopol" ? val.toUpperCase() : val;
                break;
            }
          });
          values.greet = guessGreet(values.jam);
          return values;
        };
        const validateFields = () => {
          for (const f of getCurrentTemplate().fields) {
            const el = $(`#f-${f.key}`);
            if (!el || !el.value.trim()) {
              showToast(`${f.label} wajib diisi`);
              el?.focus();
              return false;
            }
            if (f.type === "time-24" && !normalizeTime(el.value)) {
              showToast(`Format ${f.label} tidak valid`);
              el.focus();
              return false;
            }
          }
          return true;
        };
        const generate = () => {
          if (!validateFields()) return;
          const v = collectValues(),
            t = getCurrentTemplate();
          DOM.output.value = t.render(v);
          if (t.id === "unit-bjm-masuk") {
            const d = $("#f-tanggal");
            if (d) addNopolToList(v.nopol, d.value);
          }
        };
        const handleTemplateChange = () => {
          renderFields(getCurrentTemplate());
          DOM.output.value = "";
        };
        const handleCopyClick = async () => {
          const t = DOM.output.value.trim();
          if (!t) return;
          try {
            await navigator.clipboard.writeText(t);
            const oHTML = DOM.btnCopy.innerHTML,
              oText = DOM.btnCopy.innerText;
            DOM.btnCopy.innerHTML = `${ICONS.check} Tersalin!`;
            setTimeout(() => {
              DOM.btnCopy.innerHTML = oHTML;
            }, 1500);
          } catch {
            showToast("Gagal menyalin.");
          }
        };
        const handleWhatsAppClick = () => {
          const t = DOM.output.value.trim();
          if (!t) return;
          window.open(`https://wa.me/?text=${encodeURIComponent(t)}`, "_blank", "noopener,noreferrer");
        };
        const handleTimeInputBlur = (e) => {
          if (e.target.matches('input[type="text"][placeholder="HH:MM"]')) {
            const n = normalizeTime(e.target.value);
            if (n) e.target.value = n;
          }
        };
        const handleDateChange = (e) => {
          if (e.target.matches("#f-tanggal")) loadNopolListForDate(e.target.value);
        };
        const handleNopolClick = (e) => {
          const itemEl = e.target.closest(".nopol-item");
          if (!itemEl?.dataset.nopol) return;
          const nopol = nopolList.find((i) => i.nopol === itemEl.dataset.nopol);
          if (nopol) {
            nopol.done = !nopol.done;
            const d = $("#f-tanggal");
            if (d) saveNopolListForDate(d.value);
            renderNopolList();
          }
        };
        const handleExportClick = () => {
          if (nopolList.length === 0) {
            showToast("Tidak ada data nopol.");
            return;
          }
          const d = $("#f-tanggal");
          if (!d) return;
          const dateStr = d.value;
          const content = nopolList
            .map((item, index) => {
              const status = item.done ? "[SELESAI]" : "[MENUNGGU]";
              return `${index + 1}. ${item.nopol} ${status} - ${formatDateTimeForList(item.timestamp)}`;
            })
            .join("\n");
          const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = `nopol_${dateStr}.txt`;
          link.click();
          URL.revokeObjectURL(link.href);
        };
        const handleClearClick = () => {
          const d = $("#f-tanggal");
          if (!d || nopolList.length === 0) {
            showToast("Daftar sudah kosong.");
            return;
          }
          if (confirm("Anda yakin ingin menghapus semua nopol untuk tanggal ini?")) {
            const dateStr = d.value;
            localStorage.removeItem(`nopolList_${dateStr}`);
            nopolList = [];
            renderNopolList();
            showToast("Daftar nopol telah dikosongkan.");
          }
        };

        const init = () => {
          DOM.btnGen.innerHTML = `${ICONS.sparkle} Buat Template`;
          DOM.btnCopy.innerHTML = `${ICONS.copy} Salin Teks`;
          DOM.btnWa.innerHTML = `${ICONS.whatsapp} Kirim di WhatsApp`;
          DOM.btnExport.innerHTML = `${ICONS.download} Export ke .txt`;
          DOM.btnClear.innerHTML = `${ICONS.trash} Clear List`;
          createSelect();
          renderFields(getCurrentTemplate());
          DOM.btnGen.addEventListener("click", generate);
          DOM.btnCopy.addEventListener("click", handleCopyClick);
          DOM.btnWa.addEventListener("click", handleWhatsAppClick);
          DOM.fieldsContainer.addEventListener("blur", handleTimeInputBlur, true);
          DOM.fieldsContainer.addEventListener("change", handleDateChange, true);
          DOM.nopolListDisplay.addEventListener("click", handleNopolClick);
          DOM.btnExport.addEventListener("click", handleExportClick);
          DOM.btnClear.addEventListener("click", handleClearClick);
        };
        init();
      })();
    </script>
  </body>
</html>
